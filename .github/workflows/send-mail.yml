name: Build and release expo app
on:
  push:
    branches:
      - "release"
jobs:
  sendMail:
    name: Send mail
    runs-on: ubuntu-latest
    steps: 
      - name: Setup Expo
        uses: expo/expo-github-action@v7
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      # - name: ðŸ“¦ Install dependencies
      #   run: yarn install

      # - name: Build APK
      #   run: eas build --profile preview --platform android --non-interactive --clear-cache

      - name: GET APK URL from EXPO  
        run: eas build:list --json --limit=1 --platform=android |  jq -r .[0].artifacts.buildUrl

      - name: Store apk download URL in env variable
        run: echo "apk_url=$(eas build:list --json --limit=1 --platform=android |  jq -r .[0].artifacts.buildUrl)" >> $GITHUB_ENV

      - name: Send mail
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{secrets.MAIL_USERNAME}}
          password: ${{secrets.MAIL_PASSWORD}}
          subject: ${{ github.job }} job of ${{ github.repository }} has ${{ job.status }}   
          to: hamzameh122@gmail.com,hamxa2266@gmail.com
          from: Developer
          secure: true
          body: ${{ github.job }} job in worflow ${{ github.workflow }} of ${{ github.repository }} has ${{ job.status }} APK URL -> ${{ env.apk_url }}
          ignore_cert: true
          convert_markdown: true
          attachments: attachments.zip,git.diff,./dist/static/*.js
          priority: low